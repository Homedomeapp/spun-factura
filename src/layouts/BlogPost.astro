---
import { getCollection } from 'astro:content';
import Base from './Base.astro';
import '../styles/blog.css';

interface Props {
  title: string;
  description: string;
  publishedDate: string;
  updatedDate?: string;
  category?: string;
  tags?: string[];
  readingTime?: number;
  image?: string;
  imageAlt?: string;
  headings?: { depth: number; slug: string; text: string }[];
}

const { 
  title, 
  description, 
  publishedDate, 
  updatedDate, 
  category, 
  tags, 
  readingTime,
  image,
  imageAlt,
  headings = []
} = Astro.props;

const currentSlug = Astro.url.pathname.split('/').filter(Boolean).pop();

// Obtener posts relacionados - filtro por categor√≠a + fallback
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const otherPosts = allPosts.filter(post => post.slug !== currentSlug);

let relatedPosts: typeof allPosts = [];
if (category) {
  relatedPosts = otherPosts
    .filter(post => post.data.category === category)
    .sort((a, b) => new Date(b.data.publishedDate).valueOf() - new Date(a.data.publishedDate).valueOf())
    .slice(0, 4);
}

if (relatedPosts.length < 4) {
  const existingSlugs = relatedPosts.map(p => p.slug);
  const morePosts = otherPosts
    .filter(post => !existingSlugs.includes(post.slug))
    .sort((a, b) => new Date(b.data.publishedDate).valueOf() - new Date(a.data.publishedDate).valueOf())
    .slice(0, 4 - relatedPosts.length);
  relatedPosts = [...relatedPosts, ...morePosts];
}

// Filtrar headings para TOC (solo H2)
const tocHeadings = headings.filter(h => h.depth === 2);

const formattedDate = new Date(publishedDate).toLocaleDateString('es-ES', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const formattedUpdatedDate = updatedDate 
  ? new Date(updatedDate).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })
  : null;

const canonicalURL = `https://factura.spun.es${Astro.url.pathname}`;
const ogImage = image ? `https://factura.spun.es${image}` : 'https://factura.spun.es/images/og-spun-factura.png';

// Schema.org Article
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": description,
  "image": ogImage,
  "datePublished": new Date(publishedDate).toISOString(),
  "dateModified": updatedDate ? new Date(updatedDate).toISOString() : new Date(publishedDate).toISOString(),
  "author": {
    "@type": "Organization",
    "name": "SPUN",
    "url": "https://spun.es"
  },
  "publisher": {
    "@type": "Organization",
    "name": "SPUN Factura",
    "logo": {
      "@type": "ImageObject",
      "url": "https://factura.spun.es/images/SPUN-LOGO-SPUN-LOGO_Monogram-Blue.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalURL
  }
};

// Schema.org BreadcrumbList
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Inicio",
      "item": "https://factura.spun.es"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://factura.spun.es/blog"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": title,
      "item": canonicalURL
    }
  ]
};
---

<Base 
  title={`${title} | SPUN Factura`}
  description={description}
  ogImage={ogImage}
  ogType="article"
>
  <Fragment slot="head">
    <meta property="article:published_time" content={new Date(publishedDate).toISOString()}>
    {updatedDate && <meta property="article:modified_time" content={new Date(updatedDate).toISOString()} />}
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  </Fragment>

  <article class="blog-post">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs" aria-label="Breadcrumb">
      <a href="/">Inicio</a>
      <span>‚Ä∫</span>
      <a href="/blog">Blog</a>
      <span>‚Ä∫</span>
      <span>{title.length > 45 ? title.slice(0, 45) + '...' : title}</span>
    </nav>
    
    <!-- Post Header -->
    <header class="post-header">
      <div class="post-meta">
        {category && <span class="post-category">{category}</span>}
        <span>üìÖ {formattedDate}</span>
        {readingTime && <span>‚è±Ô∏è {readingTime} min de lectura</span>}
      </div>
      
      <h1>{title}</h1>
      <p class="post-description">{description}</p>
      
      {tags && tags.length > 0 && (
        <div class="post-tags">
          {tags.map(tag => <span>#{tag}</span>)}
        </div>
      )}
    </header>
    
    <!-- Featured Image -->
    {image && (
      <img 
        src={image} 
        alt={imageAlt || title} 
        class="featured-image"
        width="1200"
        height="675"
        loading="eager"
      />
    )}
    
    <!-- Table of Contents -->
    {tocHeadings.length >= 2 && (
      <nav class="toc" aria-label="Tabla de contenidos">
        <div class="toc-title">Contenido del art√≠culo</div>
        <ol class="toc-list">
          {tocHeadings.map((heading) => (
            <li>
              <a href={`#${heading.slug}`}>{heading.text}</a>
            </li>
          ))}
        </ol>
      </nav>
    )}
    
    <!-- Article Content -->
    <div class="article-content">
      <slot />
    </div>
    
    <!-- Post Footer -->
    <footer class="post-footer">
      {formattedUpdatedDate && (
        <p class="last-updated">√öltima actualizaci√≥n: {formattedUpdatedDate}</p>
      )}
      
      <a href="/blog" class="back-link">‚Üê Volver al blog</a>
    </footer>
    
    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="related-posts">
        <h3>Art√≠culos relacionados</h3>
        <div class="related-grid">
          {relatedPosts.map(post => (
            <a href={`/blog/${post.slug}`} class="related-card">
              <h4>{post.data.title}</h4>
              <p>{post.data.description.length > 100 ? post.data.description.slice(0, 100) + '...' : post.data.description}</p>
            </a>
          ))}
        </div>
      </section>
    )}
  </article>
</Base>
